name: Build and Deploy Docker Image to Multi-Region EC2

on:
  push:
    branches:
      - main

jobs:
  build-and-push-to-ecr: # ì´ ì‘ì—…ì€ ë©”ì´ìŠ¨ë‹˜ ê¸°ì¡´ ë‚´ìš© ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
    name: Build and Push to ECR
    runs-on: ubuntu-latest
    outputs:
      built_ecr_repository: my-node-app # ë©”ì´ìŠ¨ë‹˜ì˜ ì‹¤ì œ ECR ë¦¬í¬ì§€í† ë¦¬ ì´ë¦„
      built_image_tag: ${{ github.sha }}

    steps:
      - name: ğŸ›ï¸ Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }} # ECR ë¦¬í¬ì§€í† ë¦¬ê°€ ìˆëŠ” ì£¼ ë¦¬ì „ (ì˜ˆ: ap-northeast-2)

      - name: ğŸ·ï¸ Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: ğŸ—ï¸ Build, tag, and push image to Amazon ECR
        env:
          ECR_REGISTRY_URL: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY_NAME: my-node-app # ë©”ì´ìŠ¨ë‹˜ì˜ ì‹¤ì œ ECR ë¦¬í¬ì§€í† ë¦¬ ì´ë¦„
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "Building image for ECR Registry: $ECR_REGISTRY_URL"
          echo "Target Repository: $ECR_REPOSITORY_NAME"
          echo "Image Tag: $IMAGE_TAG"
          
          docker build -t $ECR_REGISTRY_URL/$ECR_REPOSITORY_NAME:$IMAGE_TAG .
          docker push $ECR_REGISTRY_URL/$ECR_REPOSITORY_NAME:$IMAGE_TAG
          
          echo "Image pushed to ECR: $ECR_REGISTRY_URL/$ECR_REPOSITORY_NAME:$IMAGE_TAG"

  deploy-to-ec2-seoul: # â­ ì´ ì‘ì—…ì˜ script ë¶€ë¶„ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤! â­
    name: Deploy to EC2 (Seoul)
    runs-on: ubuntu-latest
    needs: build-and-push-to-ecr
    
    steps:
      - name: ğŸ Debug Seoul Variables # ì´ ë””ë²„ê·¸ ë‹¨ê³„ëŠ” ê·¸ëŒ€ë¡œ ë‘ì—ˆìŠµë‹ˆë‹¤.
        run: |
          echo "Seoul EC2 Host: ${{ secrets.EC2_HOST_SEOUL }}"
          echo "AWS Account ID for ECR: ${{ secrets.AWS_ACCOUNT_ID }}"
          echo "ECR Repository from needs: [${{ needs.build-and-push-to-ecr.outputs.built_ecr_repository }}]"
          echo "Image Tag from needs: [${{ needs.build-and-push-to-ecr.outputs.built_image_tag }}]"
      
      - name: ğŸšš Deploy to Seoul EC2 instance
        uses: appleboy/ssh-action@v1.0.3 # ë©”ì´ìŠ¨ë‹˜ì´ ì‚¬ìš©í•˜ì‹œë˜ ë²„ì „
        with:
          host: ${{ secrets.EC2_HOST_SEOUL }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: | # â­ ì´ ì•„ë˜ script: ë‚´ìš©ì„ ì´ì „ ë‹µë³€ì—ì„œ ë“œë¦° ê²ƒìœ¼ë¡œ êµì²´í–ˆìŠµë‹ˆë‹¤. â­
            echo "ì„œìš¸ EC2 ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘ (`date`)"
            set -e # ì˜¤ë¥˜ ë°œìƒ ì‹œ ì¦‰ì‹œ ìŠ¤í¬ë¦½íŠ¸ ì¤‘ë‹¨

            # --- 0. ë³€ìˆ˜ ì„¤ì • (ECR ì •ë³´ëŠ” needs contextì—ì„œ ê°€ì ¸ì˜´) ---
            AWS_ACCOUNT_ID_IN_SCRIPT="${{ secrets.AWS_ACCOUNT_ID }}" # ìŠ¤í¬ë¦½íŠ¸ ë‚´ ë³€ìˆ˜ëª… ì¶©ëŒ ë°©ì§€
            AWS_DEFAULT_REGION_IN_SCRIPT="ap-northeast-2" # ì„œìš¸ ë¦¬ì „ ECR ê¸°ì¤€

            # build ì‘ì—…ì—ì„œ ì „ë‹¬ëœ ECR ë¦¬í¬ì§€í† ë¦¬ ì´ë¦„ê³¼ ì´ë¯¸ì§€ íƒœê·¸ ì‚¬ìš©
            ECR_REPOSITORY_FROM_BUILD_IN_SCRIPT="${{ needs.build-and-push-to-ecr.outputs.built_ecr_repository }}"
            IMAGE_TAG_FROM_BUILD_IN_SCRIPT="${{ needs.build-and-push-to-ecr.outputs.built_image_tag }}"

            ECR_REGISTRY_URL_SEOUL_IN_SCRIPT="${AWS_ACCOUNT_ID_IN_SCRIPT}.dkr.ecr.${AWS_DEFAULT_REGION_IN_SCRIPT}.amazonaws.com"
            IMAGE_URI_IN_SCRIPT="${ECR_REGISTRY_URL_SEOUL_IN_SCRIPT}/${ECR_REPOSITORY_FROM_BUILD_IN_SCRIPT}:${IMAGE_TAG_FROM_BUILD_IN_SCRIPT}"
            
            # ì• í”Œë¦¬ì¼€ì´ì…˜ ì»¨í…Œì´ë„ˆì— ë¶€ì—¬í•  ê³ ìœ í•œ ì´ë¦„ (ë©”ì´ìŠ¨ë‹˜ ê¸°ì¡´ ì´ë¦„ ì‚¬ìš©)
            CONTAINER_NAME_IN_SCRIPT="my-running-app-seoul"

            echo "ë°°í¬ ëŒ€ìƒ ì´ë¯¸ì§€: ${IMAGE_URI_IN_SCRIPT}"
            echo "ì‚¬ìš©í•  ì»¨í…Œì´ë„ˆ ì´ë¦„: ${CONTAINER_NAME_IN_SCRIPT}"

            # --- 1. AWS ECR ë¡œê·¸ì¸ (ì¤‘ìš”!) ---
            echo "AWS ECRì— ë¡œê·¸ì¸í•©ë‹ˆë‹¤ (${AWS_DEFAULT_REGION_IN_SCRIPT})..."
            aws ecr get-login-password --region ${AWS_DEFAULT_REGION_IN_SCRIPT} | sudo docker login --username AWS --password-stdin ${ECR_REGISTRY_URL_SEOUL_IN_SCRIPT}
            echo "ECR ë¡œê·¸ì¸ ì„±ê³µ."

            # --- 2. ìµœì‹  Docker ì´ë¯¸ì§€ Pull ---
            echo "ìµœì‹  ì´ë¯¸ì§€ë¥¼ Pullí•©ë‹ˆë‹¤: ${IMAGE_URI_IN_SCRIPT}"
            sudo docker pull ${IMAGE_URI_IN_SCRIPT}
            if [ $? -ne 0 ]; then echo "!!! docker pull ì‹¤íŒ¨! (ì„œìš¸)"; exit 1; fi
            echo "ì´ë¯¸ì§€ Pull ì™„ë£Œ."

            # --- 3. ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ (ìˆì„ ê²½ìš°) ---
            echo "ê¸°ì¡´ '${CONTAINER_NAME_IN_SCRIPT}' ì»¨í…Œì´ë„ˆë¥¼ í™•ì¸í•˜ê³  ì¤‘ì§€/ì‚­ì œí•©ë‹ˆë‹¤..."
            if [ "$(sudo docker ps -q -f name=^/${CONTAINER_NAME_IN_SCRIPT}$)" ]; then # ì •í™•í•œ ì´ë¦„ ë§¤ì¹­
                echo "ì‹¤í–‰ ì¤‘ì¸ '${CONTAINER_NAME_IN_SCRIPT}' ì»¨í…Œì´ë„ˆë¥¼ ì¤‘ì§€í•©ë‹ˆë‹¤."
                sudo docker stop ${CONTAINER_NAME_IN_SCRIPT}
            else
                echo "ì‹¤í–‰ ì¤‘ì¸ '${CONTAINER_NAME_IN_SCRIPT}' ì»¨í…Œì´ë„ˆê°€ ì—†ìŠµë‹ˆë‹¤."
            fi

            if [ "$(sudo docker ps -aq -f name=^/${CONTAINER_NAME_IN_SCRIPT}$)" ]; then
                echo "ê¸°ì¡´ '${CONTAINER_NAME_IN_SCRIPT}' ì»¨í…Œì´ë„ˆë¥¼ ì‚­ì œí•©ë‹ˆë‹¤."
                sudo docker rm ${CONTAINER_NAME_IN_SCRIPT}
            else
                echo "ì‚­ì œí•  ê¸°ì¡´ '${CONTAINER_NAME_IN_SCRIPT}' ì»¨í…Œì´ë„ˆê°€ ì—†ìŠµë‹ˆë‹¤."
            fi
            echo "ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì²˜ë¦¬ ì™„ë£Œ."

            # --- 4. ìƒˆë¡œìš´ Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (í™˜ê²½ ë³€ìˆ˜ ì£¼ì…) ---
            echo "ìƒˆë¡œìš´ '${CONTAINER_NAME_IN_SCRIPT}' ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤..."
            sudo docker run -d \
              -p 80:3000 \
              --name ${CONTAINER_NAME_IN_SCRIPT} \
              --restart always \
              -e NODE_ENV="production" \
              -e DB_HOST="${{ secrets.DB_HOST_SEOUL }}" \
              -e DB_USER="${{ secrets.DB_USER_SEOUL }}" \
              -e DB_PASSWORD="${{ secrets.DB_PASSWORD_SEOUL }}" \
              -e DB_NAME="${{ secrets.DB_NAME_SEOUL }}" \
              -e SESSION_SECRET="${{ secrets.SESSION_SECRET }}" \
              -e OPENWEATHERMAP_API_KEY="${{ secrets.OPENWEATHERMAP_API_KEY_SECRET }}" \
              -e Maps_API_KEY="${{ secrets.MAPS_API_KEY_SECRET }}" \
              ${IMAGE_URI_IN_SCRIPT}
            if [ $? -ne 0 ]; then echo "!!! docker run ì‹¤íŒ¨! (ì„œìš¸)"; exit 1; fi
            echo "ìƒˆë¡œìš´ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ìš”ì²­ ì™„ë£Œ."

            # --- 5. ë¶ˆí•„ìš”í•œ Docker ì´ë¯¸ì§€ ì •ë¦¬ (ë©”ì´ìŠ¨ë‹˜ ê¸°ì¡´ ë¡œì§) ---
            echo "ë¶ˆí•„ìš”í•œ Docker ì´ë¯¸ì§€ë¥¼ ì •ë¦¬í•©ë‹ˆë‹¤..."
            sudo docker image prune -af || true # ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰
            echo "ì´ë¯¸ì§€ ì •ë¦¬ ì™„ë£Œ."
            
            # --- 6. ì‹¤í–‰ í™•ì¸ (ê°„ë‹¨ ë¡œê·¸) ---
            echo "ì ì‹œ í›„ '${CONTAINER_NAME_IN_SCRIPT}' ì»¨í…Œì´ë„ˆ ìƒíƒœë¥¼ í™•ì¸í•©ë‹ˆë‹¤..."
            sleep 5 # ì»¨í…Œì´ë„ˆê°€ ì‹œì‘ë  ì‹œê°„ì„ ì ì‹œ ì¤ë‹ˆë‹¤.
            sudo docker ps -f name=^/${CONTAINER_NAME_IN_SCRIPT}$
            echo "'${CONTAINER_NAME_IN_SCRIPT}' ì»¨í…Œì´ë„ˆì˜ ìµœê·¼ ë¡œê·¸ ì¼ë¶€:"
            sudo docker logs --tail 20 ${CONTAINER_NAME_IN_SCRIPT}

            echo "âœ… ì„œìš¸ EC2 ë°°í¬ ì™„ë£Œ! (`date`)"

  deploy-to-ec2-tokyo: # ì´ ì‘ì—…ì€ ë©”ì´ìŠ¨ë‹˜ ê¸°ì¡´ ë‚´ìš© ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤. (ë„ì¿„ëŠ” ì œì‘ ì¤‘)
    name: Deploy to EC2 (Tokyo)
    runs-on: ubuntu-latest
    needs: build-and-push-to-ecr
    steps:
      - name: ğŸ Debug Tokyo Variables
        run: |
          echo "Tokyo EC2 Host: ${{ secrets.EC2_HOST_TOKYO }}"
          echo "AWS Account ID for ECR: ${{ secrets.AWS_ACCOUNT_ID }}"
          echo "ECR Repository from needs: [${{ needs.build-and-push-to-ecr.outputs.built_ecr_repository }}]"
          echo "Image Tag from needs: [${{ needs.build-and-push-to-ecr.outputs.built_image_tag }}]"

      - name: ğŸšš Deploy to Tokyo EC2 instance
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST_TOKYO }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # ECR ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì£¼ì†Œ ì§ì ‘ êµ¬ì„± (ë„ì¿„ ë¦¬ì „ìš©)
            ECR_REGISTRY_URL_TOKYO="${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.ap-northeast-1.amazonaws.com" # ë„ì¿„ ë¦¬ì „
            ECR_REPOSITORY_VAL="${{ needs.build-and-push-to-ecr.outputs.built_ecr_repository }}"
            IMAGE_TAG_VAL="${{ needs.build-and-push-to-ecr.outputs.built_image_tag }}"

            if [ -z "$ECR_REGISTRY_URL_TOKYO" ] || [ -z "$ECR_REPOSITORY_VAL" ] || [ -z "$IMAGE_TAG_VAL" ] || [ "${{ secrets.AWS_ACCOUNT_ID }}" == "" ]; then
              echo "ì˜¤ë¥˜: ECR ì´ë¯¸ì§€ ì •ë³´ë¥¼ êµ¬ì„±í•˜ëŠ” ë° í•„ìš”í•œ ê°’ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤ (ë„ì¿„)."
              exit 1
            fi

            IMAGE_URI="$ECR_REGISTRY_URL_TOKYO/$ECR_REPOSITORY_VAL:$IMAGE_TAG_VAL"
            CONTAINER_NAME="my-running-app-tokyo"
            
            echo "ë°°í¬í•  ìƒˆë¡œìš´ ì´ë¯¸ì§€ URI (ë„ì¿„): $IMAGE_URI"
            # ë„ì¿„ëŠ” ì œì‘ ì¤‘ì´ë¯€ë¡œ, ì‹¤ì œ docker pull ë° runì€ ì£¼ì„ ì²˜ë¦¬í•˜ê±°ë‚˜ ë‚˜ì¤‘ì— í™œì„±í™”
            # sudo docker pull $IMAGE_URI
            # if [ $? -ne 0 ]; then echo "docker pull ì‹¤íŒ¨! (ë„ì¿„)"; exit 1; fi

            # if [ "$(sudo docker ps -q -f name=$CONTAINER_NAME)" ]; then
            #   sudo docker stop $CONTAINER_NAME && sudo docker rm $CONTAINER_NAME
            # fi
            # echo "ë„ì¿„ EC2ì— ìƒˆ ì»¨í…Œì´ë„ˆ ì‹œì‘..."
            # sudo docker run -d \
            #   -p 3000:3000 \
            #   -e "OPENWEATHERMAP_API_KEY=${{ secrets.OPENWEATHERMAP_API_KEY_SECRET }}" \
            #   -e "Maps_API_KEY=${{ secrets.MAPS_API_KEY_SECRET }}" \
            #   -e "DB_HOST=${{ secrets.DB_HOST_TOKYO }}" \
            #   -e "DB_USER=${{ secrets.DB_USER_TOKYO }}" \
            #   -e "DB_PASSWORD=${{ secrets.DB_PASSWORD_TOKYO }}" \
            #   -e "DB_NAME=${{ secrets.DB_NAME_TOKYO }}" \
            #   -e "SESSION_SECRET=${{ secrets.SESSION_SECRET }}" \
            #   --restart always \
            #   --name $CONTAINER_NAME \
            #   $IMAGE_URI
            # if [ $? -ne 0 ]; then echo "docker run ì‹¤íŒ¨! (ë„ì¿„)"; exit 1; fi
            
            # sudo docker image prune -af || true
            echo "âœ… ë„ì¿„ EC2 ë°°í¬ ì‘ì—…ì€ í˜„ì¬ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤ (ì‹¤ì œ ë°°í¬ëŠ” ì£¼ì„ ì²˜ë¦¬ë¨)."
            # sudo docker ps -f name=$CONTAINER_NAME
