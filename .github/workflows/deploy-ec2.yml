name: Deploy Node.js App to EC2 (SSH) # ì›Œí¬í”Œë¡œìš° ì´ë¦„

on:
  push:
    branches:
      - main # 'main' ë¸Œëœì¹˜ì— ì½”ë“œê°€ í‘¸ì‹œë  ë•Œë§ˆë‹¤ ì‹¤í–‰

jobs:
  deploy: # 'deploy' ì‘ì—… ì •ì˜
    name: Deploy to EC2 server # ì‘ì—… ì´ë¦„
    runs-on: ubuntu-latest # GitHub Actions ì‹¤í–‰ í™˜ê²½

    steps: # ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰ë  ë‹¨ê³„ë“¤
      - name: ğŸ›ï¸ Checkout code from GitHub
        uses: actions/checkout@v4 # ì½”ë“œ ê°€ì ¸ì˜¤ê¸° ì•¡ì…˜

      - name: âš™ï¸ Setup Node.js environment
        uses: actions/setup-node@v4 # Node.js í™˜ê²½ ì„¤ì • ì•¡ì…˜
        with:
          node-version: '18' # EC2 ì„œë²„ì— ì„¤ì¹˜í•œ Node.js ë²„ì „ê³¼ ì¼ì¹˜ì‹œí‚¤ì„¸ìš” (ì˜ˆ: '18' ë˜ëŠ” '18.x')

      - name: ğŸ“¦ Install dependencies
        run: npm ci # package-lock.jsonì„ ì‚¬ìš©í•˜ì—¬ ì˜ì¡´ì„± íŒ¨í‚¤ì§€ ì„¤ì¹˜

      # í”„ë¡œì íŠ¸ ë¹Œë“œ ê³¼ì •ì´ í•„ìš”í•˜ë‹¤ë©´ ì—¬ê¸°ì— ì¶”ê°€í•©ë‹ˆë‹¤.
      # ì˜ˆì‹œ: React, Vue ë“±ì˜ í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ
      # - name: ğŸ—ï¸ Build project
      #   run: npm run build

      - name: ğŸšš Deploy to EC2 server via SSH
        uses: appleboy/ssh-action@v1.0.3 # SSH ì•¡ì…˜ (ìµœì‹  ë²„ì „ í™•ì¸ ê¶Œì¥)
        with:
          host: ${{ secrets.EC2_HOST }} # GitHub Secretsì—ì„œ EC2 í˜¸ìŠ¤íŠ¸ ì£¼ì†Œ ê°€ì ¸ì˜¤ê¸°
          username: ${{ secrets.EC2_USERNAME }} # GitHub Secretsì—ì„œ EC2 ì‚¬ìš©ì ì´ë¦„ ê°€ì ¸ì˜¤ê¸° (ec2-user)
          key: ${{ secrets.EC2_SSH_KEY }} # GitHub Secretsì—ì„œ SSH ë¹„ë°€í‚¤ ê°€ì ¸ì˜¤ê¸°
          port: 22 # SSH í¬íŠ¸ (ê¸°ë³¸ê°’)
          script: | # EC2 ì„œë²„ì—ì„œ ì‹¤í–‰ë  ëª…ë ¹ì–´ë“¤
            # 1. ì• í”Œë¦¬ì¼€ì´ì…˜ ë””ë ‰í† ë¦¬ ì„¤ì •
            APP_DIR="/home/${{ secrets.EC2_USERNAME }}/my-website" # ì‚¬ìš©ì ì´ë¦„ì— ë§ê²Œ ìë™ ì„¤ì •
            echo "ë°°í¬ ë””ë ‰í† ë¦¬: $APP_DIR"

            # 2. ë””ë ‰í† ë¦¬ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ ë° ì½”ë“œ ì—…ë°ì´íŠ¸
            if [ ! -d "$APP_DIR" ]; then
              echo "ë°°í¬ ë””ë ‰í† ë¦¬ê°€ ì—†ì–´ ìƒˆë¡œ clone í•©ë‹ˆë‹¤: $APP_DIR"
              git clone https://github.com/${{ github.repository }}.git "$APP_DIR"
              cd "$APP_DIR"
            else
              echo "ë°°í¬ ë””ë ‰í† ë¦¬ê°€ ì¡´ì¬í•©ë‹ˆë‹¤. ìµœì‹  ì½”ë“œë¥¼ pull í•©ë‹ˆë‹¤: $APP_DIR"
              cd "$APP_DIR"
              echo "í˜„ì¬ ë¸Œëœì¹˜ì—ì„œ ë³€ê²½ì‚¬í•­ ì„ì‹œ ì €ì¥ (git stash)"
              git stash push --include-untracked || true # stash ì‹¤íŒ¨ ì‹œì—ë„ ê³„ì† ì§„í–‰
              echo "ì›ê²© ì €ì¥ì†Œì—ì„œ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸° (git pull origin main)"
              git pull origin main
              echo "ì„ì‹œ ì €ì¥ëœ ë³€ê²½ì‚¬í•­ ë‹¤ì‹œ ì ìš© ì‹œë„ (git stash pop)"
              git stash pop || true # pop ì‹¤íŒ¨ ì‹œ (ì¶©ëŒ ë“±)ì—ë„ ê³„ì† ì§„í–‰
            fi

            echo "í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬: $(pwd)"
            echo "í˜„ì¬ ë¸Œëœì¹˜ ì •ë³´:"
            git branch

            echo "ìš´ì˜ í™˜ê²½ìš© ì˜ì¡´ì„± íŒ¨í‚¤ì§€ ì„¤ì¹˜ (npm ci --production)"
            npm ci --production # server.js ì‹¤í–‰ì— í•„ìš”í•œ íŒ¨í‚¤ì§€ë§Œ ì„¤ì¹˜

            echo "pm2ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ ê´€ë¦¬ (ì‚­ì œ í›„ ì‹œì‘ ë° ìƒíƒœ ì €ì¥)"
            # ê¸°ì¡´ì— ê°™ì€ ì´ë¦„ìœ¼ë¡œ ì‹¤í–‰ ì¤‘ì¸ ì•±ì´ ìˆë‹¤ë©´ ì‚­ì œ (ì—†ìœ¼ë©´ ê·¸ëƒ¥ ë„˜ì–´ê°)
            pm2 delete my-node-app || true
            # server.jsë¥¼ 'my-node-app'ì´ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ pm2ë¡œ ì‹œì‘
            pm2 start server.js --name "my-node-app"
            # í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ pm2 í”„ë¡œì„¸ìŠ¤ ëª©ë¡ì„ ì €ì¥ (ì„œë²„ ì¬ë¶€íŒ… ì‹œ ìë™ ì‹¤í–‰ì„ ìœ„í•´)
            pm2 save

            echo "âœ… EC2 ì„œë²„ ë°°í¬ ì™„ë£Œ! pm2 listë¡œ ìƒíƒœ í™•ì¸:"
            pm2 list # ë°°í¬ ë§ˆì§€ë§‰ì— pm2 ìƒíƒœë¥¼ ë¡œê·¸ë¡œ ë‚¨ê¹€
