name: Build and Deploy Docker Image to EC2 (via ECR)

on:
  push:
    branches:
      - main # 'main' ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ ì‹¤í–‰

jobs:
  build-and-push-to-ecr: # 1ë‹¨ê³„: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ECRì— í‘¸ì‹œ
    name: Build and Push to ECR
    runs-on: ubuntu-latest # GitHub Actions ì‹¤í–‰ í™˜ê²½

    outputs: # âœ¨ ì´ ì‘ì—…ì˜ ì¶œë ¥ì„ ë‹¤ìŒ ì‘ì—…ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •
      image_uri: ${{ steps.build-image.outputs.image_uri }}

    steps:
      - name: ğŸ›ï¸ Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }} # GitHub Secret
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }} # GitHub Secret
          aws-region: ap-northeast-2 # ë˜ëŠ” ë©”ì´ìŠ¨ë‹˜ì˜ ECR/EC2 ë¦¬ì „ (ì˜ˆ: ì‹œë“œë‹ˆëŠ” ap-southeast-2)

      - name: ğŸ·ï¸ Login to Amazon ECR
        id: login-ecr # ì´ ë‹¨ê³„ì— idë¥¼ ë¶€ì—¬í•˜ì—¬ outputsì„ ì°¸ì¡°í•  ìˆ˜ ìˆê²Œ í•¨
        uses: aws-actions/amazon-ecr-login@v2

      - name: ğŸ—ï¸ Build, tag, and push image to Amazon ECR
        id: build-image # ì´ ë‹¨ê³„ì— idë¥¼ ë¶€ì—¬í•˜ì—¬ outputsì„ ì°¸ì¡°í•  ìˆ˜ ìˆê²Œ í•¨
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: my-node-app # âœ¨ ë©”ì´ìŠ¨ë‹˜ì˜ ì‹¤ì œ ECR ë¦¬í¬ì§€í† ë¦¬ ì´ë¦„ìœ¼ë¡œ ë³€ê²½!
          IMAGE_TAG: ${{ github.sha }} # Git ì»¤ë°‹ í•´ì‹œë¥¼ ì´ë¯¸ì§€ íƒœê·¸ë¡œ ì‚¬ìš©
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          echo "image_uri=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

  deploy-to-ec2: # 2ë‹¨ê³„: EC2ì— ì ‘ì†í•˜ì—¬ ìƒˆ Docker ì´ë¯¸ì§€ë¡œ ì—…ë°ì´íŠ¸
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: build-and-push-to-ecr # ì´ì „ 'build-and-push-to-ecr' ì‘ì—…ì´ ì„±ê³µí•´ì•¼ ì‹¤í–‰ë¨

    steps:
      - name: âš™ï¸ Configure AWS credentials (for ECR login on EC2 if needed, or other AWS commands)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }} # GitHub Secret
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }} # GitHub Secret
          aws-region: ap-northeast-2 # ë˜ëŠ” ë©”ì´ìŠ¨ë‹˜ì˜ EC2 ë¦¬ì „

      - name: ğŸšš Deploy to EC2 instance
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }} # GitHub Secret (EC2 Public IP)
          username: ${{ secrets.EC2_USERNAME }} # GitHub Secret (ì˜ˆ: ec2-user)
          key: ${{ secrets.EC2_SSH_KEY }} # GitHub Secret (EC2 ì ‘ì†ìš© SSH ë¹„ë°€í‚¤)
          script: |
            # EC2 ì¸ìŠ¤í„´ìŠ¤ì— ECR ReadOnly ê¶Œí•œì´ ìˆëŠ” IAM ì—­í• ì´ ì—°ê²°ë˜ì–´ ìˆë‹¤ë©´,
            # ì•„ë˜ ECR ë¡œê·¸ì¸ ê³¼ì •ì€ ë” ê°„ë‹¨í•´ì§€ê±°ë‚˜ ìƒëµë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            # ì—¬ê¸°ì„œëŠ” aws-actions/amazon-ecr-loginì„ Runnerì—ì„œ ì‚¬ìš©í–ˆìœ¼ë¯€ë¡œ,
            # EC2ì—ì„œëŠ” AWS CLIë¥¼ ì‚¬ìš©í•˜ì—¬ ECRì— ë¡œê·¸ì¸í•˜ëŠ” ì˜ˆì‹œë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.
            # (ë˜ëŠ” EC2 ì¸ìŠ¤í„´ìŠ¤ í”„ë¡œíŒŒì¼ì— ECR ì ‘ê·¼ ê¶Œí•œì„ ì£¼ëŠ” ê²ƒì´ ë” ì¼ë°˜ì ì…ë‹ˆë‹¤)
            echo "ECR ë¡œê·¸ì¸ ì‹œë„..."
            aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | docker login --username AWS --password-stdin ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com
            # ìœ„ ${{ secrets.AWS_REGION }}ì€ configure-aws-credentialsì—ì„œ ì‚¬ìš©í•œ ë¦¬ì „ê³¼ ë™ì¼í•´ì•¼ í•©ë‹ˆë‹¤.
            # ${{ secrets.AWS_ACCOUNT_ID }} Secretë„ GitHubì— ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤. (AWS ê³„ì • ID)

            IMAGE_URI="${{ needs.build-and-push-to-ecr.outputs.image_uri }}"
            CONTAINER_NAME="my-running-app"

            echo "ë°°í¬í•  ìƒˆë¡œìš´ ì´ë¯¸ì§€ URI: $IMAGE_URI"
            echo "EC2ì—ì„œ Docker ì»¨í…Œì´ë„ˆ ì—…ë°ì´íŠ¸ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."

            echo "1. ìµœì‹  ì´ë¯¸ì§€ pull ì‹œë„..."
            docker pull $IMAGE_URI

            echo "2. ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ ì‹œë„ (ë§Œì•½ ì‹¤í–‰ ì¤‘ì´ë¼ë©´)..."
            if [ "$(docker ps -q -f name=$CONTAINER_NAME)" ]; then
                echo "ê¸°ì¡´ $CONTAINER_NAME ì»¨í…Œì´ë„ˆë¥¼ ì¤‘ì§€í•˜ê³  ì‚­ì œí•©ë‹ˆë‹¤."
                docker stop $CONTAINER_NAME
                docker rm $CONTAINER_NAME
            else
                echo "ì‹¤í–‰ ì¤‘ì¸ $CONTAINER_NAME ì»¨í…Œì´ë„ˆê°€ ì—†ìŠµë‹ˆë‹¤."
            fi

            echo "3. ìƒˆë¡œìš´ ì´ë¯¸ì§€ë¡œ $CONTAINER_NAME ì»¨í…Œì´ë„ˆë¥¼ ì‹œì‘í•©ë‹ˆë‹¤."
            # í™˜ê²½ ë³€ìˆ˜ëŠ” Docker ì´ë¯¸ì§€ì— ì§ì ‘ í¬í•¨ì‹œí‚¤ì§€ ì•Šê³ , ì‹¤í–‰ ì‹œì ì— ì£¼ì…í•©ë‹ˆë‹¤.
            # ì´ ê°’ë“¤ì€ GitHub Secretsì—ì„œ ê°€ì ¸ì˜µë‹ˆë‹¤.
            docker run -d \
              -p 3000:3000 \
              -e "OPENWEATHERMAP_API_KEY=${{ secrets.OPENWEATHERMAP_API_KEY_SECRET }}" \
              -e "Maps_API_KEY=${{ secrets.Maps_API_KEY_SECRET }}" \
              -e "DB_HOST=${{ secrets.DB_HOST }}" \
              -e "DB_USER=${{ secrets.DB_USER }}" \
              -e "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" \
              -e "DB_NAME=${{ secrets.DB_NAME }}" \
              -e "SESSION_SECRET=${{ secrets.SESSION_SECRET }}" \
              --restart always \
              --name $CONTAINER_NAME \
              $IMAGE_URI

            echo "(ì„ íƒ ì‚¬í•­) ì˜¤ë˜ëœ Docker ì´ë¯¸ì§€ ì •ë¦¬ ì‹œë„..."
            docker image prune -af || true 

            echo "âœ… EC2 ë°°í¬ ì™„ë£Œ! ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ:"
            docker ps -f name=$CONTAINER_NAME
