name: Build Docker Image and Deploy to Multi-Region EC2

on:
  push:
    branches:
      - main

jobs:
  build-and-push-to-ecr:
    name: Build and Push to ECR
    runs-on: ubuntu-latest
    outputs:
      image_uri: ${{ steps.build-image.outputs.image_uri }}
    steps:
      - name: ğŸ›ï¸ Checkout code
        uses: actions/checkout@v4
      - name: âš™ï¸ Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }} # ECRì´ ìˆëŠ” ë¦¬ì „
      - name: ğŸ·ï¸ Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      - name: ğŸ—ï¸ Build, tag, and push image to Amazon ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: my-node-app # âœ¨ ì‹¤ì œ ECR ë¦¬í¬ì§€í† ë¦¬ ì´ë¦„
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          echo "image_uri=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

  # ì„œìš¸ ë¦¬ì „ì— ë°°í¬í•˜ëŠ” ì‘ì—…
  deploy-to-ec2-seoul:
    name: Deploy to EC2 (Seoul)
    runs-on: ubuntu-latest
    needs: build-and-push-to-ecr # ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ ì‘ì—…ì´ ì„±ê³µí•´ì•¼ ì‹¤í–‰
    
    # âœ¨ ì¤‘ìš”: ì„œìš¸ ë¦¬ì „ìš© í™˜ê²½ ë³€ìˆ˜(DB ì ‘ì† ì •ë³´ ë“±)ë¥¼ ì–´ë–»ê²Œ ì „ë‹¬í• ì§€ ê²°ì • í•„ìš”
    # ë°©ë²• 1: GitHub Secretsì— ë¦¬ì „ë³„ë¡œ Secretsë¥¼ ë§Œë“¦ (ì˜ˆ: DB_HOST_SEOUL, DB_HOST_TOKYO)
    # ë°©ë²• 2: ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì‹œì‘ë  ë•Œ EC2 ì¸ìŠ¤í„´ìŠ¤ ë©”íƒ€ë°ì´í„°ë‚˜ íƒœê·¸ë¥¼ ì½ì–´ ë¦¬ì „ì„ íŒŒì•…í•˜ê³ ,
    #         Parameter Store ë“±ì—ì„œ í•´ë‹¹ ë¦¬ì „ì— ë§ëŠ” ì„¤ì •ì„ ê°€ì ¸ì˜¤ë„ë¡ ì•± ìˆ˜ì • (ë” ê³ ê¸‰)
    # ì—¬ê¸°ì„œëŠ” ë°©ë²• 1ì„ ê°€ì •í•˜ê³ , ì›Œí¬í”Œë¡œìš°ì—ì„œ Secretsë¥¼ ì „ë‹¬í•©ë‹ˆë‹¤.
    # ë˜ëŠ”, ëª¨ë“  ë¦¬ì „ì—ì„œ ë™ì¼í•œ Parameter Store ê²½ë¡œë¥¼ ì‚¬ìš©í•˜ê³ , EC2ì˜ IAM ì—­í• ë¡œ ì ‘ê·¼í•˜ê²Œ í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

    steps:
      - name: âš™ï¸ Configure AWS credentials (for ECR login on EC2 if needed)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2 # ì„œìš¸ ë¦¬ì „

      - name: ğŸšš Deploy to Seoul EC2 instance
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST_SEOUL }} # âœ¨ ì„œìš¸ EC2 í˜¸ìŠ¤íŠ¸ Secret
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ECR ë¡œê·¸ì¸ (ì„œìš¸)..."
            aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.ap-northeast-2.amazonaws.com

            IMAGE_URI="${{ needs.build-and-push-to-ecr.outputs.image_uri }}"
            CONTAINER_NAME="my-running-app-seoul" # ì»¨í…Œì´ë„ˆ ì´ë¦„ì— ë¦¬ì „ êµ¬ë¶„ì ì¶”ê°€

            echo "ë°°í¬í•  ì´ë¯¸ì§€ URI: $IMAGE_URI"
            docker pull $IMAGE_URI
            if [ "$(docker ps -q -f name=$CONTAINER_NAME)" ]; then
                docker stop $CONTAINER_NAME
                docker rm $CONTAINER_NAME
            fi
            echo "ì„œìš¸ EC2ì— ìƒˆ ì»¨í…Œì´ë„ˆ ì‹œì‘..."
            docker run -d \
              -p 3000:3000 \
              -e "OPENWEATHERMAP_API_KEY=${{ secrets.OPENWEATHERMAP_API_KEY_SECRET }}" \
              -e "Maps_API_KEY=${{ secrets.Maps_API_KEY_SECRET }}" \
              -e "DB_HOST=${{ secrets.DB_HOST_SEOUL }}"           # âœ¨ ì„œìš¸ RDS í˜¸ìŠ¤íŠ¸ Secret
              -e "DB_USER=${{ secrets.DB_USER_SEOUL }}"           # âœ¨ ì„œìš¸ RDS ì‚¬ìš©ì Secret
              -e "DB_PASSWORD=${{ secrets.DB_PASSWORD_SEOUL }}"   # âœ¨ ì„œìš¸ RDS ë¹„ë°€ë²ˆí˜¸ Secret
              -e "DB_NAME=${{ secrets.DB_NAME_SEOUL }}"           # âœ¨ ì„œìš¸ RDS DB ì´ë¦„ Secret
              -e "SESSION_SECRET=${{ secrets.SESSION_SECRET }}" \
              --restart always \
              --name $CONTAINER_NAME \
              $IMAGE_URI
            docker image prune -af || true
            echo "âœ… ì„œìš¸ EC2 ë°°í¬ ì™„ë£Œ!"

  # ë„ì¿„ ë¦¬ì „ì— ë°°í¬í•˜ëŠ” ì‘ì—…
  deploy-to-ec2-tokyo:
    name: Deploy to EC2 (Tokyo)
    runs-on: ubuntu-latest
    needs: build-and-push-to-ecr

    steps:
      - name: âš™ï¸ Configure AWS credentials (for ECR login on EC2 if needed)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-1 # ë„ì¿„ ë¦¬ì „

      - name: ğŸšš Deploy to Tokyo EC2 instance
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST_TOKYO }} # âœ¨ ë„ì¿„ EC2 í˜¸ìŠ¤íŠ¸ Secret
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ECR ë¡œê·¸ì¸ (ë„ì¿„)..."
            aws ecr get-login-password --region ap-northeast-1 | docker login --username AWS --password-stdin ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.ap-northeast-1.amazonaws.com

            IMAGE_URI="${{ needs.build-and-push-to-ecr.outputs.image_uri }}"
            CONTAINER_NAME="my-running-app-tokyo" # ì»¨í…Œì´ë„ˆ ì´ë¦„ì— ë¦¬ì „ êµ¬ë¶„ì ì¶”ê°€

            echo "ë°°í¬í•  ì´ë¯¸ì§€ URI: $IMAGE_URI"
            docker pull $IMAGE_URI
            if [ "$(docker ps -q -f name=$CONTAINER_NAME)" ]; then
                docker stop $CONTAINER_NAME
                docker rm $CONTAINER_NAME
            fi
            echo "ë„ì¿„ EC2ì— ìƒˆ ì»¨í…Œì´ë„ˆ ì‹œì‘..."
            docker run -d \
              -p 3000:3000 \
              -e "OPENWEATHERMAP_API_KEY=${{ secrets.OPENWEATHERMAP_API_KEY_SECRET }}" \
              -e "Maps_API_KEY=${{ secrets.Maps_API_KEY_SECRET }}" \
              -e "DB_HOST=${{ secrets.DB_HOST_TOKYO }}"           # âœ¨ ë„ì¿„ RDS í˜¸ìŠ¤íŠ¸ Secret
              -e "DB_USER=${{ secrets.DB_USER_TOKYO }}"           # âœ¨ ë„ì¿„ RDS ì‚¬ìš©ì Secret
              -e "DB_PASSWORD=${{ secrets.DB_PASSWORD_TOKYO }}"   # âœ¨ ë„ì¿„ RDS ë¹„ë°€ë²ˆí˜¸ Secret
              -e "DB_NAME=${{ secrets.DB_NAME_TOKYO }}"           # âœ¨ ë„ì¿„ RDS DB ì´ë¦„ Secret
              -e "SESSION_SECRET=${{ secrets.SESSION_SECRET }}" \
              --restart always \
              --name $CONTAINER_NAME \
              $IMAGE_URI
            docker image prune -af || true
            echo "âœ… ë„ì¿„ EC2 ë°°í¬ ì™„ë£Œ!"
