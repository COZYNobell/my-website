# ~/terraform/main.tf

# 서울과 도쿄, 두 개의 리전에 대한 AWS 공급자를 정의합니다.
provider "aws" {
  alias  = "seoul"
  region = "ap-northeast-2"
}

provider "aws" {
  alias  = "tokyo"
  region = "ap-northeast-1"
}

# 서울 리전의 인프라를 정의하는 모듈을 호출합니다.
module "seoul" {
  source    = "./envs/seoul"
  providers = { aws = aws.seoul } # 이 모듈은 서울 리전 프로바이더를 사용합니다.

  # 루트의 variables.tf를 통해 전달받은 변수들을 서울 모듈에 전달합니다.
  db_name         = var.db_name_seoul
  db_user         = var.db_user
  db_password     = var.db_password
  route53_zone_id = var.route53_zone_id
}

# 도쿄 리전의 인프라를 정의하는 모듈을 호출합니다.
module "tokyo" {
  source    = "./envs/tokyo"
  providers = { aws = aws.tokyo } # 이 모듈은 도쿄 리전 프로바이더를 사용합니다.

  # 루트의 variables.tf를 통해 전달받은 변수들을 도쿄 모듈에 전달합니다.
  db_name         = var.db_name_tokyo
  db_user         = var.db_user
  db_password     = var.db_password
  route53_zone_id = var.route53_zone_id

  # 도쿄 RDS Replica가 서울 RDS를 복제하기 위해, 서울 모듈의 출력값(ARN)을 전달합니다.
  primary_rds_arn = module.seoul.rds_arn
}
