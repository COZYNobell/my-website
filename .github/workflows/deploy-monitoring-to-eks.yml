name: Deploy Monitoring Stack to EKS

on:
  workflow_dispatch:

jobs:
  deploy-monitoring:
    name: Deploy Prometheus & Grafana to EKS
    runs-on: ubuntu-latest
    # ✨ OIDC 인증을 위한 권한 추가 ✨
    permissions:
      id-token: write
      contents: read
    
    steps:
      # ✨ AWS 자격 증명 설정 스텝 수정 ✨
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_IAM_ROLE_ARN }}
          aws-region: ap-northeast-2

      - name: Install Utilities (kubectl, helm)
        run: |
          echo "Installing kubectl..."
          curl -o kubectl https://s3.us-west-2.amazonaws.com/amazon-eks/1.28.5/2024-01-04/bin/linux/amd64/kubectl
          chmod +x ./kubectl
          sudo mv ./kubectl /usr/local/bin/
          
          echo "Installing Helm..."
          curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
          chmod 700 get_helm.sh
          ./get_helm.sh

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --region ap-northeast-2 --name my-weather-app-cluster

      - name: Add Prometheus community Helm repository
        run: |
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          helm repo update

      - name: Deploy kube-prometheus-stack
        run: |
          kubectl create namespace monitoring --dry-run=client -o yaml | kubectl apply -f -
          helm upgrade --install prometheus-stack prometheus-community/kube-prometheus-stack \
            --namespace monitoring \
            --set grafana.adminPassword='${{ secrets.GRAFANA_ADMIN_PASSWORD }}' \
            --wait

      - name: Verify deployment status
        run: |
          echo "Verifying deployment status in 'monitoring' namespace..."
          kubectl get pods -n monitoring
