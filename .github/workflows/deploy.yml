name: Build and Deploy Docker Image to EC2 (via ECR)

on:
  push:
    branches:
      - main # 'main' ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ ì‹¤í–‰

jobs:
  build-and-push-to-ecr: # 1ë‹¨ê³„: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ECRì— í‘¸ì‹œ
    name: Build and Push to ECR
    runs-on: ubuntu-latest # GitHub Actions ì‹¤í–‰ í™˜ê²½

    steps:
      - name: ğŸ›ï¸ Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4 # AWS ìê²© ì¦ëª… ì„¤ì • ì•¡ì…˜
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }} # GitHub Secretìœ¼ë¡œ ì €ì¥ëœ AWS ì•¡ì„¸ìŠ¤ í‚¤ ID
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }} # GitHub Secretìœ¼ë¡œ ì €ì¥ëœ AWS ë¹„ë°€ ì•¡ì„¸ìŠ¤ í‚¤
          aws-region: ap-northeast-2 # ë˜ëŠ” ë©”ì´ìŠ¨ë‹˜ì˜ ECR/EC2 ë¦¬ì „

      - name: ğŸ·ï¸ Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2 # ECR ë¡œê·¸ì¸ ì•¡ì…˜

      - name: ğŸ—ï¸ Build, tag, and push image to Amazon ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }} # ECR ë¡œê·¸ì¸ ë‹¨ê³„ì—ì„œ ì–»ì€ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì£¼ì†Œ
          ECR_REPOSITORY: my-node-app # ë©”ì´ìŠ¨ë‹˜ ECR ë¦¬í¬ì§€í† ë¦¬ ì´ë¦„
          IMAGE_TAG: ${{ github.sha }} # Git ì»¤ë°‹ í•´ì‹œë¥¼ ì´ë¯¸ì§€ íƒœê·¸ë¡œ ì‚¬ìš© (ë˜ëŠ” ë‹¤ë¥¸ íƒœê·¸ ì „ëµ)
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          echo "image_uri=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT # ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ì‚¬ìš©í•  ì´ë¯¸ì§€ URI ì¶œë ¥

  deploy-to-ec2: # 2ë‹¨ê³„: EC2ì— ì ‘ì†í•˜ì—¬ ìƒˆ Docker ì´ë¯¸ì§€ë¡œ ì—…ë°ì´íŠ¸
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: build-and-push-to-ecr # ì´ì „ 'build-and-push-to-ecr' ì‘ì—…ì´ ì„±ê³µí•´ì•¼ ì‹¤í–‰ë¨

    steps:
      - name: âš™ï¸ Configure AWS credentials (EC2 ì ‘ì†ìš©ì´ ì•„ë‹Œ, SSM ë“± ë‹¤ë¥¸ AWS ì„œë¹„ìŠ¤ ì‚¬ìš© ì‹œ í•„ìš”í•  ìˆ˜ ìˆìŒ)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2 # ë˜ëŠ” ë©”ì´ìŠ¨ë‹˜ì˜ EC2 ë¦¬ì „

      - name: ğŸšš Deploy to EC2 instance by pulling new image and restarting container
        uses: appleboy/ssh-action@v1.0.3 # ê¸°ì¡´ SSH ì•¡ì…˜ ì‚¬ìš©
        with:
          host: ${{ secrets.EC2_HOST }} # EC2 Public IP (ìƒˆë¡œ ë§Œë“  EC2 IPë¡œ ì—…ë°ì´íŠ¸ í•„ìš”)
          username: ${{ secrets.EC2_USERNAME }} # ì˜ˆ: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }} # EC2 ì ‘ì†ìš© SSH ë¹„ë°€í‚¤ (ì´ê²ƒì€ ECR ì ‘ê·¼ í‚¤ì™€ ë‹¤ë¦„!)
          script: |
            # ECRì—ì„œ ìƒˆ ì´ë¯¸ì§€ pull (IAM ì—­í• ì´ EC2ì— ë¶€ì—¬ë˜ì–´ ECR ì ‘ê·¼ ê¶Œí•œì´ ìˆë‹¤ë©´ aws ecr get-login-password ë¶ˆí•„ìš”)
            # ë˜ëŠ”, EC2 user_dataì—ì„œ ì£¼ê¸°ì ìœ¼ë¡œ docker login í•˜ë„ë¡ ì„¤ì •
            # ê°€ì¥ ê°„ë‹¨í•˜ê²ŒëŠ” EC2ì— ECR ReadOnly ê¶Œí•œì„ ê°€ì§„ IAM ì—­í• ì„ ë¶€ì—¬í•©ë‹ˆë‹¤.
            aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin ${{ steps.build-image.outputs.ECR_REGISTRY }}
            
            IMAGE_URI="${{ needs.build-and-push-to-ecr.outputs.image_uri }}" # ì´ì „ ë‹¨ê³„ì—ì„œ ì „ë‹¬ë°›ì€ ì´ë¯¸ì§€ URI
            CONTAINER_NAME="my-running-app" # ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ ì´ë¦„ (docker run ì‹œ --nameìœ¼ë¡œ ì§€ì •í•œ ì´ë¦„)

            echo "ìƒˆë¡œìš´ ì´ë¯¸ì§€ URI: $IMAGE_URI"
            echo "EC2ì—ì„œ Docker ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."

            # 1. ìµœì‹  ì´ë¯¸ì§€ pull
            docker pull $IMAGE_URI

            # 2. ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ (ë§Œì•½ ì‹¤í–‰ ì¤‘ì´ë¼ë©´)
            if [ "$(docker ps -q -f name=$CONTAINER_NAME)" ]; then
                echo "ê¸°ì¡´ $CONTAINER_NAME ì»¨í…Œì´ë„ˆë¥¼ ì¤‘ì§€í•˜ê³  ì‚­ì œí•©ë‹ˆë‹¤."
                docker stop $CONTAINER_NAME
                docker rm $CONTAINER_NAME
            fi

            # 3. ìƒˆë¡œìš´ ì´ë¯¸ì§€ë¡œ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
            #    .env íŒŒì¼ ëŒ€ì‹  í™˜ê²½ ë³€ìˆ˜ë¥¼ ì§ì ‘ ì „ë‹¬í•©ë‹ˆë‹¤.
            #    ì´ ê°’ë“¤ì€ GitHub Secretsì—ì„œ ê°€ì ¸ì™€ì„œ ì—¬ê¸°ì— ì§ì ‘ ë„£ê±°ë‚˜,
            #    EC2 ì¸ìŠ¤í„´ìŠ¤ ì‹œì‘ ì‹œ Parameter Store/Secrets Managerì—ì„œ ê°€ì ¸ì™€
            #    EC2 ì¸ìŠ¤í„´ìŠ¤ ë‚´ì˜ í™˜ê²½ ì„¤ì • íŒŒì¼(/etc/environment ë“±)ì— ì €ì¥í•´ë‘ê³ 
            #    docker run ì‹œ ì°¸ì¡°í•˜ë„ë¡ í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
            #    ì—¬ê¸°ì„œëŠ” GitHub Secretsë¥¼ ì§ì ‘ ì‚¬ìš©í•œë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤. (ë³´ì•ˆìƒ ë” ì¢‹ì€ ë°©ë²•ì€ EC2 ë©”íƒ€ë°ì´í„°, IAM ì—­í•  í™œìš©)
            echo "ìƒˆë¡œìš´ ì´ë¯¸ì§€ë¡œ $CONTAINER_NAME ì»¨í…Œì´ë„ˆë¥¼ ì‹œì‘í•©ë‹ˆë‹¤."
            docker run -d \
              -p 3000:3000 \
              -e "OPENWEATHERMAP_API_KEY=${{ secrets.OPENWEATHERMAP_API_KEY_SECRET }}" \
              -e "Maps_API_KEY=${{ secrets.Maps_API_KEY_SECRET }}" \
              -e "DB_HOST=${{ secrets.DB_HOST }}" \
              -e "DB_USER=${{ secrets.DB_USER }}" \
              -e "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" \
              -e "DB_NAME=${{ secrets.DB_NAME }}" \
              -e "SESSION_SECRET=${{ secrets.SESSION_SECRET }}" \
              --restart always \
              --name $CONTAINER_NAME \
              $IMAGE_URI

            # (ì„ íƒ ì‚¬í•­) ì˜¤ë˜ëœ Docker ì´ë¯¸ì§€ ì •ë¦¬
            docker image prune -af || true 

            echo "âœ… EC2 ë°°í¬ ì™„ë£Œ!"
